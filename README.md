# EmailNotificationIn1S

Расширение - уведомление почтовым сообщением при первом внесении данных (создание элемента справочника, проведение документа). Отправка почтового сообщения выполняется через фоновое задание. Это расширение является доработкой расширения https://github.com/KistanovSerhii/ExtensionZUPNoticeFired.git

1. Реквизит "Ответственный исполнитель" справочника "Договоры" - это ссылка на справочник физические лица где есть реквизит "Email" и он должен быть заполнен!

2. Реквизит "Владелец бюджета" справочника "Договоры" - это дополнительный реквизит и для указания почты для данного реквизита мы должны зайти в регистр сведений "Дополнительные значения доп. объектов" и добавить ссылку на доп. реквизит и указать почту которая будет ему присвоена.

3. Уведомление отправляется только тем объектам которых нет в регистре сведений "Уведомление отправлено" 
(после первого отправления создается запись в данном регистре по отправленному объекту тем самым мы выполняем отправку уведомления только один раз)


![image](https://user-images.githubusercontent.com/28355711/196092948-888fe2ad-143c-425f-92e1-c9176272c535.png)

![image](https://user-images.githubusercontent.com/28355711/196093252-ddc92145-9cf8-42f7-8023-5ab678889091.png)

![image](https://user-images.githubusercontent.com/28355711/196093113-9dc98546-26a1-4bf7-a96d-697cd269ff11.png)

![image](https://user-images.githubusercontent.com/28355711/196093516-cef402af-d53e-4f3e-a52a-52da57eadc91.png)

![image](https://user-images.githubusercontent.com/28355711/196093578-5e3b61c6-510d-4203-b1fa-40ad49383d25.png)

# EmailNotificationIn1S_v2

В данной версии:
1. Изменен алгоритм заполнения текста письма (в текст записываем &ИмяРеквизита, в цикле выполнится замена на значение реквизита)
2. Добавлен регистр сведений "ПодпискаНаРассылку" где указываются подписчики на рассылку (email адреса и тип рассылки), а в v1 адрес
получается из конкретного объекта базы данных (например проводимый документ может содержать реквизит получательУведомления)

# ВАЖНО:
Через фоновое задание дублируется отправка сообщения если:
    
    - Пользователь нажал "Провести" -> запустил фоновое задание отправки уведомления, но процесс отправки это длительная операция
      (подключение к почте, отправка ...) по этой причине пользователь имеет возможность запустить еще одно фоновое задание отправки уведомления
      (например после "Провести" нажмет "Провести и закрыть") и оно тоже отправится так как в регистр сведений "УведомлениеОтправлено" запись будет
      добавлена исключительно по завершению выполнения запущенного фонового задания!!!
      
      - Решение: реализация через реквизит "УведомлениеОтправлено" с типом булево (я так не делал так как не хотел менять конфу, НО можно было сделать
        через дополнительный реквизит).
        В таком случаи необходимо: 
        1. Устанавливать данному реквизиту ложь при копировании объекта
        2. Сразу по подписке (в начале процедуры) проверять реквизит и выполнять/не выполнять процедуру отправки
        3. Если проверка реквизита дает добро на выполнения отправки (равно Истина) тогда устанавливаем зня Истина
        4. Если отправить не удалось - установить данному реквизиту знч ложь
        
*Пример кода при использовании реквизита "УведомлениеОтправлено" с типом булево:

// ПриКопировании
Процедура ОчиститьПризнакУведомлениеОтправлено(Источник, ОбъектКопирования) Экспорт
	
	Попытка
		Источник.УведомлениеОтправлено = Ложь;
	Исключение
	КонецПопытки;
	
КонецПроцедуры


// Процедура - событие первичное внесение данных (Создание элемента справочника или ПРОВЕДЕНИЕ документа)
//
// Параметры:
//  Источник - СправочникСсылка, ДокументСсылка - Ссылка на любой Справочник или Документ
//
Процедура ПервичноеВнесениеДанных(Источник, Отказ, РежимЗаписи) Экспорт

	// Через реквизит объекта +++
	// Иначе жмут "Провести" - стартует фоновое задание отправки уведомление
	// и затем жмут "Провести и закрыть" тем самым стартует еще одно фоновое задание,
	// но в регистре "УведомлениеОтправлено" еще нет записи так как отправка еще не
	// успела отработать (отправка после нажатия "Провести")	
	_уведомлениеОтправлено = Ложь;
	Попытка
		_уведомлениеОтправлено = Источник.УведомлениеОтправлено;
	Исключение
	КонецПопытки;
	// Через реквизит объекта +++

	
	ЭтоРабочаяБД = ИТФоновоеВыполнение.ЭтоРабочаяБазаДанных();	

	Если НЕ ЭтоРабочаяБД ИЛИ _уведомлениеОтправлено Тогда
		Возврат;
	КонецЕсли;
	
	Попытка
		Источник.УведомлениеОтправлено = Истина;
	Исключение
	КонецПопытки;
	
	_ФоновоеВыполнение = Истина;
	
	
	ПараметрыВызываемогоМетода = Новый Структура;
	
	ПараметрыВызываемогоМетода.Вставить("ИсточникТип");
	ПараметрыВызываемогоМетода.Вставить("ИсточникИмя");
	ПараметрыВызываемогоМетода.Вставить("ИсточникУИД");
	
	ПараметрыВызываемогоМетода.ИсточникТип = ИТФоновоеВыполнение.ПолучитьИмяТипаОбъекта(Источник);
	ПараметрыВызываемогоМетода.ИсточникИмя = Источник.Метаданные().Имя;
	ПараметрыВызываемогоМетода.ИсточникУИД = Строка(Источник.Ссылка.УникальныйИдентификатор());
	
	
	
	Запрос = Новый Запрос;
	Запрос.Текст = СтрШаблон("ВЫБРАТЬ ВерсияДанных ИЗ %1.%2 ГДЕ Ссылка = &Ссылка", 
	ПараметрыВызываемогоМетода.ИсточникТип, ПараметрыВызываемогоМетода.ИсточникИмя);
	Запрос.УстановитьПараметр("Ссылка", Источник.Ссылка);
	ВыборкаДанныхБД = Запрос.Выполнить().Выбрать();
	ДанныхБДСуществуют = ВыборкаДанныхБД.Следующий();



	// Отправить только если: данные были изменены.
	Если ДанныхБДСуществуют И ВыборкаДанныхБД.ВерсияДанных = Источник.Ссылка.ВерсияДанных Тогда
		Возврат;
	КонецЕсли;	
	
 
 
	Если _ФоновоеВыполнение Тогда
		// Фоновое выполнение +++
		НастройкаФоновогоВыполнения = ИТФоновоеВыполнение.НовыйПараметрыВызоваПроцедурыФоновогоЗадания();
		
		НастройкаФоновогоВыполнения.Сигнатура	= "ИТПодпискаНаСобытие.УведомитьОПервичномВнесенииДанных(ИсточникТип, ИсточникИмя, ИсточникУИД);";
		НастройкаФоновогоВыполнения.Передать	= ПараметрыВызываемогоМетода;
		
		ИТФоновоеВыполнение.ЗапуститьФоновоеВыполнение(НастройкаФоновогоВыполнения);
		// Фоновое выполнение ---
	Иначе
		УведомитьОПервичномВнесенииДанных(ПараметрыВызываемогоМетода.ИсточникТип, ПараметрыВызываемогоМетода.ИсточникИмя, ПараметрыВызываемогоМетода.ИсточникУИД);
	КонецЕсли;
	
КонецПроцедуры        
      
      

// Процедура - уведомление о первичном внесении данных фоновое выполнение (Создание элемента справочника или ПРОВЕДЕНИЕ документа)
//
// Примечание:
//	Метод должен быть Экспортнум для возможности вызова в фоновом задании
//
// Параметры:
//  Источник - СправочникСсылка, ДокументСсылка - Ссылка на любой Справочник или Документ
//
Процедура УведомитьОПервичномВнесенииДанных(ИсточникТип, ИсточникИмя, ИсточникУИД) Экспорт
	
	// ...
    	
	УспешноОтправлено = ИТИнтернетПочта.ОтправитьПочтовоеСообщение(ПочтаОписаниеПисьма);
	
	Если УспешноОтправлено Тогда
		Попытка			
			
   // так как это вариант через реквизит - ЭТО МОЖНО УДАЛИТЬ +++
   //МенеджерЗаписи 			= РегистрыСведений.УведомлениеОтправлено.СоздатьМенеджерЗаписи();
			//МенеджерЗаписи.Источник = ИсточникСсылка;
			//МенеджерЗаписи.Записать();
			// так как это вариант через реквизит - ЭТО МОЖНО УДАЛИТЬ ---
   
			Сообщить("Уведомление успешно отправлено!");
		Исключение
			Сообщить("Ошибка отправки уведомления!");

   // так как это вариант через реквизит - ЭТО ДОБАВИТЬ +++
			обкИсточника = ИсточникСсылка.ПлучитьОбъект();
			обкИсточника.УведомлениеОтправлено = Истина;
			обкИсточника.Записать();
   // так как это вариант через реквизит - ЭТО ДОБАВИТЬ ---
   
		КонецПопытки
	КонецЕсли;
	
КонецПроцедуры
